éå¸¸å¥½çš„é—®é¢˜ï¼ä½ é—®åˆ°äº† **ORM æ›´æ–°æ“ä½œçš„æ ¸å¿ƒæ€æƒ³**ï¼Œæˆ‘æ¥ä¸€æ­¥æ­¥è§£é‡Šæ¸…æ¥šï¼š

---

## ğŸ” ä½ çš„å†™æ³• vs æˆ‘çš„å†™æ³•ï¼šæœ¬è´¨åŒºåˆ«

| æ–¹å¼ | ä½ çš„å†™æ³• | æˆ‘çš„å†™æ³• |
|------|--------|--------|
| **SQL å±‚çº§** | ç›´æ¥å‘ `UPDATE ... SET ...` è¯­å¥ï¼ˆç±»ä¼¼åŸç”Ÿ SQLï¼‰ | å…ˆåŠ è½½å¯¹è±¡ â†’ ä¿®æ”¹å±æ€§ â†’ è®© ORM è‡ªåŠ¨ç”Ÿæˆ UPDATE |
| **æ˜¯å¦ç»è¿‡æ¨¡å‹** | âŒ è·³è¿‡æ¨¡å‹ï¼Œç›´æ¥æ”¹æ•°æ®åº“ | âœ… é€šè¿‡ Python å¯¹è±¡ä¿®æ”¹ï¼ŒORM è‡ªåŠ¨åŒæ­¥åˆ° DB |
| **èƒ½å¦è§¦å‘æ¨¡å‹é€»è¾‘** | âŒ ä¸èƒ½ï¼ˆæ¯”å¦‚ `updated_at` è‡ªåŠ¨æ›´æ–°ã€éªŒè¯ç­‰ï¼‰ | âœ… èƒ½ |
| **è¿”å›å€¼** | æ²¡æœ‰è¿”å›æ›´æ–°åçš„å¯¹è±¡ | è¿”å›å®Œæ•´ã€æœ€æ–°çš„ Book å¯¹è±¡ |

---

## ğŸ§  ä¸ºä»€ä¹ˆæˆ‘è¦ç”¨ `for + setattr`ï¼Ÿ

### 1. **`book_data.model_dump(exclude_unset=True)` çš„ä½œç”¨**

å‡è®¾ä½ çš„ `Book_update` æ˜¯ä¸€ä¸ª Pydantic æ¨¡å‹ï¼ˆç”¨ `@pydantic.dataclasses.dataclass` æˆ–ç»§æ‰¿ `BaseModel`ï¼‰ï¼Œæ¯”å¦‚ï¼š

```python
class Book_update(BaseModel):
    title: str | None = None
    author: str | None = None
    published_year: int | None = None
```

ç”¨æˆ·åªä¼ äº†ï¼š
```json
{ "title": "æ–°ä¹¦å" }
```

é‚£ä¹ˆï¼š
- `book_data.model_dump()` â†’ `{ "title": "æ–°ä¹¦å", "author": None, "published_year": None }`
- `book_data.model_dump(exclude_unset=True)` â†’ `{ "title": "æ–°ä¹¦å" }` âœ… åªåŒ…å«ç”¨æˆ·çœŸæ­£ä¼ çš„å­—æ®µï¼

> âœ… è¿™æ ·å°±ä¸ä¼šæŠŠæ²¡ä¼ çš„å­—æ®µè¦†ç›–æˆ `None`ï¼ˆå¦åˆ™ä¼šæ¸…ç©ºæ•°æ®åº“ä¸­åŸæœ‰çš„ä½œè€…ä¿¡æ¯ï¼ï¼‰

---

### 2. **`setattr(book, key, value)` æ˜¯ä»€ä¹ˆï¼Ÿ**

è¿™æ˜¯ Python çš„å†…ç½®å‡½æ•°ï¼Œä½œç”¨æ˜¯ï¼š**åŠ¨æ€ç»™å¯¹è±¡è®¾ç½®å±æ€§**

ç­‰ä»·äºï¼š
```python
book.title = "æ–°ä¹¦å"
```

ä½†å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ç”¨æˆ·ä¼ äº†å“ªäº›å­—æ®µï¼ˆå¯èƒ½æ˜¯ titleï¼Œä¹Ÿå¯èƒ½æ˜¯ authorï¼‰ï¼Œæ‰€ä»¥ç”¨å¾ªç¯ + `setattr` é€šç”¨å¤„ç†ï¼š

```python
for key, value in update_data.items():
    setattr(book, key, value)
```

ğŸ‘‰ è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼š
> â€œå¯¹äºç”¨æˆ·ä¼ çš„æ¯ä¸€ä¸ªå­—æ®µï¼ŒæŠŠè¿™ä¸ªå­—æ®µçš„å€¼èµ‹ç»™ book å¯¹è±¡å¯¹åº”çš„å±æ€§â€

---

### 3. **ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿè€Œä¸æ˜¯ç›´æ¥å‘ UPDATE è¯­å¥ï¼Ÿ**

#### âœ… ä¼˜åŠ¿ä¸€ï¼š**è‡ªåŠ¨è§¦å‘æ¨¡å‹ä¸­çš„é€»è¾‘**
æ¯”å¦‚ä½ çš„ `Book` æ¨¡å‹å¯èƒ½æœ‰ï¼š

```python
from datetime import datetime
from sqlmodel import SQLModel, Field

class Book(SQLModel, table=True):
    id: int = Field(default=None, primary_key=True)
    title: str
    author: str
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    # æ³¨æ„ï¼šSQLModel ä¼šåœ¨æ¯æ¬¡æ›´æ–°æ—¶è‡ªåŠ¨è°ƒç”¨ default_factory å—ï¼Ÿ
    # ç­”æ¡ˆï¼š**ä¸ä¼šï¼é™¤éä½ ç”¨ ORM æ–¹å¼ä¿®æ”¹å¯¹è±¡**
```

å¦‚æœä½ ç”¨ä½ çš„å†™æ³•ï¼ˆ`update(Book).values(...)`ï¼‰ï¼š
- `updated_at` **ä¸ä¼šè‡ªåŠ¨æ›´æ–°**ï¼å› ä¸ºè¿™æ˜¯çº¯ SQL æ“ä½œï¼Œç»•è¿‡äº†æ¨¡å‹ã€‚

ä½†å¦‚æœä½ ç”¨æˆ‘çš„å†™æ³•ï¼ˆ`setattr` + `session.add`ï¼‰ï¼š
- SQLModel / SQLAlchemy ä¼šæ£€æµ‹åˆ°å¯¹è±¡è¢«ä¿®æ”¹
- åœ¨ `commit` æ—¶ç”Ÿæˆ UPDATE è¯­å¥
- **å¹¶ä¸”å¯ä»¥é…åˆ `@property`ã€äº‹ä»¶ç›‘å¬å™¨ã€æˆ–æ‰‹åŠ¨è®¾ç½® `updated_at = datetime.utcnow()` æ¥æ›´æ–°æ—¶é—´**

> ğŸ’¡ å®é™…ä¸Šï¼ŒSQLModel é»˜è®¤**ä¸ä¼šè‡ªåŠ¨æ›´æ–° `updated_at`**ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°ï¼š
> ```python
> from sqlalchemy import Column, DateTime
> from sqlalchemy.sql import func
>
> class Book(SQLModel, table=True):
>     updated_at: datetime = Field(
>         sa_column=Column(DateTime, default=func.now(), onupdate=func.now())
>     )
> ```
> è€Œè¿™ç§ `onupdate=func.now()` **åªæœ‰åœ¨ ORM æ–¹å¼æ›´æ–°æ—¶æ‰ç”Ÿæ•ˆ**ï¼åŸç”Ÿ `update()` è¯­å¥ä¸ä¼šè§¦å‘ã€‚

#### âœ… ä¼˜åŠ¿äºŒï¼š**è¿”å›å®Œæ•´çš„æ›´æ–°åå¯¹è±¡**
å‰ç«¯é€šå¸¸å¸Œæœ›æ‹¿åˆ°æ›´æ–°åçš„å®Œæ•´æ•°æ®ï¼ˆæ¯”å¦‚å¸¦ `updated_at` æ—¶é—´ï¼‰ï¼Œè€Œä½ çš„å†™æ³•æ²¡æœ‰è¿”å›ä»»ä½•ä¸œè¥¿ã€‚

æˆ‘çš„å†™æ³•æœ€å `return book`ï¼Œè€Œä¸” `await session.refresh(book)` ç¡®ä¿æ‹¿åˆ°æ•°æ®åº“æœ€æ–°å€¼ï¼ˆåŒ…æ‹¬æ•°æ®åº“è§¦å‘å™¨æ”¹çš„å­—æ®µï¼‰ã€‚

#### âœ… ä¼˜åŠ¿ä¸‰ï¼š**æ›´å®‰å…¨ã€æ›´ç¬¦åˆ ORM æ€æƒ³**
- ä¸å®¹æ˜“å†™å‡ºé”™è¯¯çš„ SQL
- å­—æ®µåæ‹¼å†™é”™è¯¯ä¼šè¢« IDE æç¤ºï¼ˆå› ä¸ºæ˜¯ `book.title`ï¼Œä¸æ˜¯å­—ç¬¦ä¸² `"title"`ï¼‰
- æ”¯æŒç±»å‹æ£€æŸ¥

---

## ğŸ›  é‚£ä½ çš„å†™æ³•å®Œå…¨é”™äº†å—ï¼Ÿ

**ä¸æ˜¯å®Œå…¨é”™**ï¼Œåªæ˜¯ **é€‚ç”¨åœºæ™¯ä¸åŒ**ï¼š

- å¦‚æœä½ ç¡®å®šï¼š
  - ä¸éœ€è¦è§¦å‘æ¨¡å‹é€»è¾‘
  - ä¸éœ€è¦è¿”å›æ›´æ–°åçš„å¯¹è±¡
  - åªæƒ³å¿«é€Ÿæ‰¹é‡æ›´æ–°ï¼ˆæ¯”å¦‚åå°ä»»åŠ¡ï¼‰
- é‚£ä¹ˆä½ çš„ `update(Book).values(...)` å†™æ³• **æ€§èƒ½æ›´é«˜**ï¼ˆå°‘ä¸€æ¬¡ SELECTï¼‰

ä½†åœ¨ **Web API çš„å¸¸è§„ CRUD åœºæ™¯ä¸­**ï¼Œ**æ¨èä½¿ç”¨â€œåŠ è½½ â†’ ä¿®æ”¹ â†’ æäº¤â€æ¨¡å¼**ï¼Œå› ä¸ºå®ƒï¼š
- æ›´å®‰å…¨
- æ›´å¯ç»´æŠ¤
- æ›´ç¬¦åˆæ¡†æ¶è®¾è®¡å“²å­¦

---

## âœ… æœ€ç»ˆå»ºè®®

ä¿ç•™æˆ‘çš„å†™æ³•ï¼Œå¹¶ç†è§£å®ƒçš„ä»·å€¼ï¼š

```python
async def update_a_book(self, book_uid: str, book_data: Book_update, session: AsyncSession):
    book = await self.get_book(book_uid, session)
    if not book:
        raise HTTPException(status_code=404, detail="Book not found")
    
    # åªæ›´æ–°ç”¨æˆ·ä¼ çš„å­—æ®µ
    update_data = book_data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(book, key, value)  # åŠ¨æ€èµ‹å€¼
    
    session.add(book)
    await session.commit()
    await session.refresh(book)  # åŒæ­¥æ•°æ®åº“æœ€æ–°çŠ¶æ€ï¼ˆå¦‚ updated_atï¼‰
    return book
```

> ğŸ” `setattr` å°±æ˜¯â€œåŠ¨æ€èµ‹å€¼â€çš„å·¥å…·ï¼Œè®©ä½ ä¸ç”¨å†™ `if "title" in update_data: book.title = ...` è¿™ç§å†—ä½™ä»£ç ã€‚

---

å¦‚æœä½ è¿˜æ˜¯è§‰å¾—æŠ½è±¡ï¼Œæˆ‘å¯ä»¥ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼š

```python
# å‡è®¾ update_data = {"title": "æ–°ä¹¦å"}
for key, value in update_data.items():
    setattr(book, key, value)

# ç­‰ä»·äºï¼š
book.title = "æ–°ä¹¦å"
```

å¦‚æœ `update_data = {"author": "å¼ ä¸‰", "published_year": 2025}`ï¼Œå°±ç­‰ä»·äºï¼š
```python
book.author = "å¼ ä¸‰"
book.published_year = 2025
```

æ˜¯ä¸æ˜¯å¾ˆçµæ´»ï¼ŸğŸ˜

å¸Œæœ›è¿™ä¸‹ä½ å½»åº•æ˜ç™½äº†ï¼å¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œæ¬¢è¿ç»§ç»­é—®ã€‚